<!DOCTYPE html>
<html>
<head>
  <title>转储本地录像文件</title>
  <link rel="stylesheet" type="text/css" href="src/normalize.css">
  <link rel="stylesheet" type="text/css" href="style.css">
  <link rel="stylesheet" type="text/css" href="number-pb.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<div class="container">
  <p style="color: brown">注意：录像文件转储成功前，请务必不要关闭本对话框！</p>
  <p id="load-txt">正在转储语音文件... ...</p>
  <section id="random">
      <div class="number-pb">
        <div class="number-pb-shown"></div>
        <div class="number-pb-num">0%</div>
      </div>
  </section>
  <button id="btn-retry" onclick="retry()">重新转储</button>
</div>


<script>window.$ = window.jQuery = require('jquery');</script>
<script src="src/jquery.velocity.min.js"></script>
<script src="number-pb.js"></script>
<script>
  var ipc = require('electron').ipcRenderer;
  var filepath = null;
  var loopBar = $('.number-pb').NumberProgressBar();
  var cur_pos = 1;
  var status = '';
  var total_length = 0;
  var cur_type = 0; //0--mixAudio,1--mixVideo
  
  $('#btn-retry').attr('disabled',true);
  loopBar.setDuration(1000);
  cur_pos = 1;
  loopBar.reach(1);

  logger("start");
  ipc.on('main-loading', (event, arg) => {
            filepath = arg.filepath;
            logger(arg.notifyID+",status="+status);

            switch (arg.notifyID) {
                case 'load-process':              
                  loopBar.setDuration(500);
                  total_length = arg.total;
                  logger("total_length:"+total_length+" mixedLength:"+arg.mixedLength);

                  setPosByLength(arg.mixedLength);
                  break;
                case 'audio-mix-succeed':
                  if(status != 'audio-mix-succeed'){
                    status = 'audio-mix-succeed';
                    $('#load-txt').text('转储语音文件成功，正在转储视频文件...');
                    cur_pos = 15;
                    cur_type = 1;
                    setProcess(cur_pos);       
                  }
                  break;
                case 'audio-mix-failed':
                  if(status != 'audio-mix-failed'){
                    status = 'audio-mix-failed';
                    $('#load-txt').text('转储语音文件失败，可点击 重新转储 按钮重新生成！');
                    $('#btn-retry').attr('disabled',false);
                    
                  }
                  break;
                case 'video-mix-succeed':
                  if(status != 'video-mix-succeed'){
                    status = 'video-mix-succeed';
                    $('#load-txt').text('本地录像文件已转储成功，可以关闭本对话框。');
                    
                    loopBar.setDuration(100);
                    setProcess(100);
                    $('#btn-retry').attr('disabled',false);
                  }
                  break;
                case 'video-mix-failed':
                  if(status != 'video-mix-failed'){
                    status = 'video-mix-failed';
                    $('#load-txt').text('转储视频文件失败，可点击 重新转储 按钮重新生成！');
                    $('#btn-retry').attr('disabled',false);
                    
                  }
                  break;
            }
        });
  

  function retry(){
    if(filepath){
      let command={};
      command.cmd = 'saveCallBack';
      command.msg = filepath;
      ipc.send('manager-main',command);
      $('#load-txt').text('正在转储语音文件... ...');
      $('#btn-retry').attr('disabled',true);
      status = '';
      loopBar.setDuration(1000);
      cur_pos = 1;
      loopBar.reach(1);
    }
  }

  function setProcess(num){
    loopBar.reach(num);
  }

  function setPosByLength(mixedLength){
    let vpos = 0;
    if(cur_type == 0){
      //当前是mixAudio
      if(total_length >0){
        vpos = parseInt(15*(mixedLength/total_length));

        if(vpos > cur_pos && vpos<15){
          cur_pos = vpos;
          setProcess(cur_pos);
        }
      }
    }   
    else{
      //当前是mixVideo
      if(total_length >0){
        vpos = parseInt(85*(mixedLength/total_length)+15);
        if(vpos > cur_pos && vpos<100){
          cur_pos = vpos;
          setProcess(cur_pos);
        }
      }
        
    }
  }

  function logger(msg){    
    let notify = {};
    notify.msg = "loading:"+msg;
    notify.notifyID = 'notify_log'
    ipc.send('main-manager',notify);
  }
</script>
</body>
</html>